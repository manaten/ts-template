name: Sync Template

on:
  schedule:
    # Run every Monday at 9:00 JST (00:00 UTC)
    - cron: "0 0 * * 1"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: üõé Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîß Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: üîó Add template remote
        run: |
          if ! git remote | grep -q '^template$'; then
            git remote add template https://github.com/manaten/ts-template.git
          fi

      - name: üì• Fetch template changes
        run: git fetch template main

      - name: üîç Check for updates
        id: check_updates
        run: |
          git fetch template main
          BEHIND=$(git rev-list --count HEAD..template/main)
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT
          if [ "$BEHIND" -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: üåø Create sync branch
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          BRANCH_NAME="sync-template-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b "$BRANCH_NAME"

      - name: üîÑ Merge template changes
        if: steps.check_updates.outputs.has_updates == 'true'
        id: merge
        continue-on-error: true
        run: |
          git merge --no-edit template/main

      - name: üìù Create PR with successful merge
        if: steps.check_updates.outputs.has_updates == 'true' && steps.merge.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin "$BRANCH_NAME"
          gh pr create \
            --title "üîÑ Sync template updates from ts-template" \
            --body "This PR syncs the latest changes from the [ts-template](https://github.com/manaten/ts-template) repository.

          ## Changes
          This PR includes the following commits from the template:

          $(git log --oneline HEAD...template/main | head -10)

          ## Review checklist
          - [ ] Review the changes from the template
          - [ ] Ensure no conflicts with repository-specific code
          - [ ] Test the changes locally if needed

          ---
          ü§ñ This PR was automatically created by the sync-template workflow." \
            --base main \
            --head "$BRANCH_NAME"

      - name: ‚ö†Ô∏è Handle merge conflicts
        if: steps.check_updates.outputs.has_updates == 'true' && steps.merge.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git merge --abort || true
          git merge --no-commit --no-ff template/main || true

          # Commit with conflict markers if there are conflicts
          git add .
          git commit -m "Merge template updates (with conflicts)" || true

          git push origin "$BRANCH_NAME"
          gh pr create \
            --title "‚ö†Ô∏è Sync template updates (with conflicts)" \
            --body "This PR attempts to sync the latest changes from the [ts-template](https://github.com/manaten/ts-template) repository.

          ## ‚ö†Ô∏è Conflicts detected
          The merge resulted in conflicts. Please resolve the conflicts manually:

          1. Check out this branch
          2. Resolve conflicts in the affected files
          3. Commit the resolved changes
          4. Push to this branch

          ## Changes
          This PR includes the following commits from the template:

          $(git log --oneline HEAD...template/main | head -10)

          ---
          ü§ñ This PR was automatically created by the sync-template workflow." \
            --base main \
            --head "$BRANCH_NAME"

      - name: ‚úÖ No updates
        if: steps.check_updates.outputs.has_updates == 'false'
        run: echo "No updates from template repository"
